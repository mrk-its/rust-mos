name: build_rust_mos
on:
  workflow_dispatch:
    inputs:
      llvm_mos_repo:
        description: 'llvm-mos repo'
        default: 'mrk-its/llvm-mos'
        type: string
      llvm_mos_ref:
        description: 'llvm-mos ref'
        default: '13f2838f909ca839ccb4d9a6c808de7b2ea60911'
        type: string

jobs:
  build_rust_mos:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-20.04]
    steps:
      - name: Maximize build space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-android: 'true'
          remove-dotnet: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'
          remove-large-packages: 'true'
          remove-cached-tools: 'true'
          remove-swapfile: 'true'

      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch the latest Ubuntu llvm-mos release.
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          curl -LO https://github.com/${{ inputs.llvm_mos_repo }}/releases/download/llvm-mos-linux-main/llvm-mos-linux-main.tar.xz
          tar -xvf llvm-mos-linux-main.tar.xz
          curl -LO https://github.com/${{ inputs.llvm_mos_repo }}/releases/download/llvm-mos-linux-main-dev/llvm-mos-linux-main-dev.tar.xz
          tar -xvf llvm-mos-linux-main-dev.tar.xz
      - name: Fetch the latest Windows llvm-mos release.
        if: startsWith(matrix.os, 'windows')
        run: |
          curl -LO https://github.com/${{ inputs.llvm_mos_repo }}/releases/download/llvm-mos-windows-main/llvm-mos-windows-main.7z
          7z x llvm-mos-windows-main.7z
          curl -LO https://github.com/${{ inputs.llvm_mos_repo }}/releases/download/llvm-mos-windows-main-dev/llvm-mos-windows-main-dev.7z
          7z x llvm-mos-windows-main-dev.7z
      - name: Fetch the latest Mac llvm-mos release.
        if: startsWith(matrix.os, 'macos')
        run: |
          curl -LO https://github.com/${{ inputs.llvm_mos_repo }}/releases/download/llvm-mos-darwin-main/llvm-mos-darwin-main.tar.xz
          tar -xvf llvm-mos-darwin-main.tar.xz
          curl -LO https://github.com/${{ inputs.llvm_mos_repo }}/releases/download/llvm-mos-darwin-main-dev/llvm-mos-darwin-main-dev.tar.xz
          tar -xvf llvm-mos-darwin-main-dev.tar.xz

      - name: Render config.toml
        run: |
          cp ./config.toml.template ./config.toml

      - name: show config
        run: |
          cat config.toml

      - name: show config
        run: |
          cat config.toml
          echo ${GITHUB_WORKSPACE}
          ls -la ${GITHUB_WORKSPACE}


      - name: build rust-mos
        run: |
          python3 x.py dist

      - name: list dist files
        run: |
          ls -la /tmp/rust-mos-build/dist

      - name: "Release for Linux"
        if: startsWith(matrix.os, 'ubuntu')
        uses: softprops/action-gh-release@v1
        with:
          prerelease: true
          body: "rust-mos build for Linux"
          tag_name: rust-mos-linux
          files: "/tmp/rust-mos-build/dist/*.gz"
